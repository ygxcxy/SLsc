package cn.scj.service.impl;

import cn.scj.dto.PwdDto;
import cn.scj.dto.ResponseCode;
import cn.scj.mapper.AuUserMapper;
import cn.scj.model.AuUser;
import cn.scj.service.UserService;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import java.time.LocalDateTime;
import java.util.List;

/**
 * @author by Shaochenjie
 * @Classname UserServiceImpl
 * @Description TODO
 * @Date 2019/10/7 16:30
 */
@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private AuUserMapper userMapper;

    @Override
    public void save(AuUser user) {
        userMapper.save(user);
    }

    @Override
    public AuUser findUserName(String userName) {

        return userMapper.findUserName(userName);
    }

    @Override
    public AuUser findLoginCode(String loginCode) {

        return userMapper.findLoginCode(loginCode);
    }

    @Override
    public ResponseCode LoginCodeupdatePwd(PwdDto pwdDto) {
        ResponseCode responseCode = new ResponseCode();
        userMapper.LoginCodeupdatePwd(pwdDto);
        responseCode.setMsg("更改成功");
        responseCode.setCode(ResponseCode.SUCCESS);
        return responseCode;
    }

    @Override
    public ResponseCode LoginCodeupdatePwd2(PwdDto pwdDto) {
        ResponseCode responseCode = new ResponseCode();
        userMapper.LoginCodeupdatePwd2(pwdDto);
        responseCode.setMsg("更改成功");
        responseCode.setCode(ResponseCode.SUCCESS);
        return responseCode;
    }

    @Override
    public AuUser findAll(Long id) {
        return userMapper.findAll(id);
    }

    @Override
    public void updateUser(AuUser user) {
        userMapper.updateUser(user);

    }

    @Override
    public ResponseCode findAllCode(ResponseCode responseCode,String loginCode) {
        ResponseCode code = new ResponseCode();
        PageHelper.startPage(responseCode.getPage(),responseCode.getLimit());
        List<AuUser> list = userMapper.findAllCode(loginCode);
        PageInfo<AuUser> pageInfo = new PageInfo<>(list);
        code.setCode(0);
        code.setData(list);
        code.setCount(pageInfo.getTotal());
        return code;
    }

    @Override
    public ResponseCode delById(Long id) {
        ResponseCode code = new ResponseCode();
        if(id==null){
            code.setCode(ResponseCode.FAIL);
            code.setMsg("ID错误");
        }else{
            userMapper.delById(id);
            code.setCode(ResponseCode.SUCCESS);
            code.setMsg("删除成功");
        }

        return code;
    }

    @Override
    public ResponseCode delByIds(List<Integer> ids) {
        ResponseCode code = new ResponseCode();
        if(ids==null){
            code.setCode(ResponseCode.FAIL);
            code.setMsg("ID错误");
        }else{
            userMapper.delByIds(ids);
            code.setCode(ResponseCode.SUCCESS);
            code.setMsg("删除成功");
        }
        return code;
    }

    @Override
    public void add(AuUser user) {
        user.setCreateTime(LocalDateTime.now());
        user.setPassword("1");
        user.setPassword2("1");
        if(user.getRoleId()==1){
            user.setUserType("");
            user.setUserTypeName("");
        }
        userMapper.save(user);
    }

    @Override
    public ResponseCode checkPassword2(Long id, String password2) {
        ResponseCode code = new ResponseCode();
        AuUser user = userMapper.queryUserById(id);
        if (user == null){
            code.setCode(ResponseCode.FAIL);
            code.setMsg("系统错误！转账取消！");
        }else{
            if(user.getPassword2().equals(password2)){
                code.setCode(ResponseCode.SUCCESS);
                code.setMsg("验证通过！");
            }else{
                code.setCode(ResponseCode.FAIL);
                code.setMsg("验证失败！二级密码错误！");
            }
        }
        return code;
    }


}
